#!/usr/bin/env bash

function info() {
  MESSAGE=$1
  echo "[INFO] ${MESSAGE}"
}

function warn() {
  MESSAGE=$1
  echo "[WARN] ${MESSAGE}"
}

function error() {
  MESSAGE=$1
  echo "[ERROR] ${MESSAGE}"
}

AVAILABLE_STAGES=("dev" "prod")

if [ -z "${STAGE}" ]; then
  warn "STAGE is not set. Defaulting to STAGE=${AVAILABLE_STAGES[0]}"
  export STAGE=dev
else
  if [[ ! " ${AVAILABLE_STAGES[*]} " =~ " ${STAGE} " ]]; then
    error "STAGE ${STAGE} is invalid. Please choose one of [${AVAILABLE_STAGES[*]}]"
    exit 1
  fi
fi

info "Your STAGE is set to ${STAGE}"

if [ "${STAGE}" == "dev" ]; then
  SERVER_HOSTNAME="http://localhost"
  export SERVER_PORT=8080
fi

export SERVER_ADDRESS="${SERVER_HOSTNAME}:${SERVER_PORT}"
info "The server address is set to ${SERVER_ADDRESS}"

if [ "${STAGE}" == "dev" ]; then
  WEB_CLIENT_HOSTNAME="localhost"
  WEB_CLIENT_PORT=3000
fi

export WEB_CLIENT_ADDRESS="${WEB_CLIENT_HOSTNAME}:${WEB_CLIENT_PORT}"
info "The web client address is set to ${WEB_CLIENT_ADDRESS}"

if [ "${STAGE}" == "dev" ]; then
  export DB_HOSTNAME="localhost"
  export DB_PORT=5432
  export DB_NAME="skkia"
  export DB_USER="skkia"
  export DB_PASSWORD="password"
  info "The database is set to ${DB_USER}@${DB_HOSTNAME}:${DB_PORT}/${DB_NAME}"
fi

export OAUTH2_PROVIDER_NAVER_CLIENT_ID=TEMP_WILL_REMOVE
export OAUTH2_PROVIDER_NAVER_CLIENT_SECRET=TEMP_WILL_REMOVE
export OAUTH2_PROVIDER_NAVER_REDIRECT_URI=http://localhost:8080/login/oauth2/code/naver
export OAUTH2_SUCCESS_REDIRECT_URI=http://localhost:3000/oauth2/redirect

export MAIL_HOST=TEMP_WILL_REMOVE
export MAIL_USERNAME=TEMP_WILL_REMOVE
export MAIL_PASSWORD=TEMP_WILL_REMOVE

export CORS_ALLOWED_ORIGINS=http://localhost:3000,ws://localhost:3000

info "Writing environment variables to application .env files"
cat >./apps/web/.env <<EOF
NEXT_PUBLIC_BACKEND_URL=http://${SERVER_HOSTNAME}:${SERVER_PORT}
EOF
